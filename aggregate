#!/bin/bash
set -x

if [ ! -f config ] ; then echo error: no config ; exit 1 ; fi

sed -i \
 -e 's/^sy=.*/sy=2016/' \
 -e 's/^sm=.*/sm=06/' \
 -e 's/^sd=.*/sd=18/' \
 -e 's/^suffix=.*/suffix=aggregate/' \
 -e 's/^prefix=.*/prefix=aggregate/' \
 config

. ./config
make config.py

pbsreportrawalpha=pbs-report.raw.alpha.csv
pbsreportcleanedalpha=pbs-report.cleaned.alpha.csv

pbsreportrawproduction=pbs-report.raw.production.csv
pbsreportrawpartialproduction=pbs-report.raw.partial.production.csv
pbsreportcleanedproduction=pbs-report.cleaned.production.csv
pbsreportcleanedpartialproduction=pbs-report.cleaned.partial.production.csv

pbsreportrawaggregate=pbs-report.raw.$suffix.csv
pbsreportrawpartialaggregate=pbs-report.raw.partial.$suffix.csv
pbsreportcleanedaggregate=pbs-report.cleaned.$suffix.csv
pbsreportcleanedpartialaggregate=pbs-report.cleaned.partial.$suffix.csv

export MEMLIMIT=100000000
make $pbsreportrawaggregate
if [ $pbsreportrawaggregate -nt $pbsreportcleanedproduction ] ; then echo rm -f $pbsreportcleanedproduction $pbsreportcleanedpartialproduction ; fi

if [ ! -f $pbsreportcleanedproduction ] ; then
 rm -f $pbsreportcleanedaggregate && \
  make $pbsreportcleanedaggregate && \
  mv $pbsreportcleanedaggregate $pbsreportcleanedproduction && \
  mv $pbsreportcleanedpartialaggregate $pbsreportcleanedpartialproduction || \
  rm -f $pbsreportcleanedaggregate $pbsreportcleanedproduction $pbsreportcleanedpartialaggregate $pbsreportcleanedpartialproduction
fi

if [ ! -f $pbsreportcleanedalpha ] ; then
 # Alpha Phase
 gzip -dc archive/alpha/pbs-report.cleaned.alpha.csv.gz > $pbsreportcleanedalpha || \
  rm -f $pbsreportcleanedalpha
fi

cp $pbsreportcleanedalpha $pbsreportcleanedaggregate && \
 tail -n +3 $pbsreportcleanedproduction >> $pbsreportcleanedaggregate || \
 rm -f $pbsreportcleanedaggregate

cp $pbsreportcleanedalpha $pbsreportcleanedpartialaggregate && \
 tail -n +3 $pbsreportcleanedpartialproduction >> $pbsreportcleanedpartialaggregate || \
 rm -f $pbsreportcleanedpartialaggregate

./make-unused
