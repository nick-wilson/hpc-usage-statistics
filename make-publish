#!/bin/bash

. ./config

if [ $publish -eq 1 ] ; then
 echo Copy files to stakeholder home directories and update myusage command data
 # requires root permission
 su -c ./make-copyout
fi

# High level institutes
orgs="ASTAR NUS NTU CREATE SUTD SMU Industry Other"
# Individual organizations
orgs="$orgs GIS IHPC"
orgs="$orgs MACHINELEARNING"
#orgs="$orgs BEARS-BERKELEY CARES E2S2 ETHZ NRD SINBERBEST SINBERISE SMART TUM-CREATE"

# base directory
base=/app/nsccadmin/log

# Copy data to log directory
logdir=$base/usage-statistics
outputfiles=`echo {active,alldata,top100,total,org,application,user_,stats_by_core,cpu_walltime_by_user_by_application_,storage,project_}*.$suffix.csv`

if [ x"$suffix" == xaggregate ] ; then
 mv -v $outputfiles $logdir/aggregate/
 mkdir -p $logdir/aggregate/by-org
 for org in $orgs ; do
  mv -v $logdir/aggregate/*.$org.$suffix.csv $logdir/aggregate/by-org/
 done
elif [ $monthly -eq 1 ] ; then
 mv -v $outputfiles $logdir/
 mkdir -p $logdir/by-org
 for org in $orgs ; do
  mv -v $logdir/*.$org.$suffix.csv $logdir/by-org/
 done
else
 mkdir -p $logdir/weekly
 mv -v $outputfiles $logdir/weekly/
fi

# Set appropriate file permissions on data
for d in "$PWD" "$logdir" ; do
 setfacl -R -bk "$d" ;  chmod -R u+rwX,g-w,g+rX,o-rwx "$d" ; chown -R ${LOGNAME}.nscc-proj "$d"
done
