#!/bin/bash
cd `dirname "$0"` || exit $?

. ./config

if [ $publish -eq 1 ] ; then
 echo Copy files to stakeholder home directories and update myusage command data
 # requires root permission
 su -c ./make-copyout
fi

# High level institutes
orgs="ASTAR NUS NTU CREATE SUTD SMU Industry Other"
# Individual organizations
orgs="$orgs GIS IHPC KOMTECH"
orgs="$orgs MACHINELEARNING"
#orgs="$orgs BEARS-BERKELEY CARES E2S2 ETHZ NRD SINBERBEST SINBERISE SMART TUM-CREATE"

# base directory
base=/app/nsccadmin/log

# Copy data to log directory
logdir=$base/usage-statistics
outputfiles=`echo {active,alldata,top100,total,org,application,user_,stats_by_core,cpu_walltime_by_user_by_application_,storage,project_,ams-,queue_firstrun}*.$suffix.csv`

copy_to_logdir () {
 mkdir -p $logdir/$1/by-org && \
 cp -pv $outputfiles $logdir/$1/
 for org in $orgs ; do
  mv -v $logdir/$1/*.$org.$suffix.csv $logdir/$1/by-org/ 2>/dev/null
 done
 rmdir $logdir/$1/by-org 2>/dev/null
}

if [ x"$type" == xpartial ] ; then
 echo partial report, not copying output to log directory
elif [ x"$type" == xstage ] ; then
 copy_to_logdir stage
elif [ x"$type" == xyearly ] ; then
 copy_to_logdir yearly
elif [ x"$type" == xannual ] ; then
 copy_to_logdir annual
elif [ x"$type" == xaggregate ] ; then
 copy_to_logdir aggregate
elif [ x"$type" == xweekly ] ; then
 copy_to_logdir weekly
else
 copy_to_logdir
fi

# Set appropriate file permissions on data
./fix-permissions
