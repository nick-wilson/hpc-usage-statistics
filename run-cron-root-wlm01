#!/bin/bash

# This script has settings required to run statistics in cron as root on either wlm01 or wlm02
# 
# For weekly report:        GET_LATEST=1 UPDATE_MYUSAGE=1 MAKE_AGGREGATE=0
# For monthly report:       GET_LATEST=1 UPDATE_MYUSAGE=1 MAKE_AGGREGATE=1
# For pre-publication runs: GET_LATEST=0 UPDATE_MYUSAGE=0 MAKE_AGGREGATE=0

cd `dirname $0`
. ./config
monthlydir=`echo $PWD/../../${ey}${em}*`

export PATH="/app/pbs/bin:$PATH:/opt/pbs/bin:/opt/pbs/sbin"
. /etc/profile.d/modules.sh
. /app/modules/modules.sh
module load R/3.3.1
which Rscript
PATH="${PATH}:/app/git/2.9.3/bin" ; export PATH
which git

echo get latest version
./make-pull

echo clean up old results and only leave config file
make veryveryclean
if [ -d dgx ] ; then make -C dgx veryclean ; fi
if [ -d load2apps ] ; then (cd load2apps && ./clean) ; fi
if [ -d system-utilisation ] ; then (cd system-utilisation && ./clean) ; fi
if [ -d dgx/system-utilisation ] ; then (cd dgx/system-utilisation && ./clean) ; fi
if [ -d R-stats-trending ] ; then make -C R-stats-trending veryclean ; fi
if [ -d am ] ; then make -C am clean ; fi

echo first make, only interested in pbs-report data
make pbs-report.raw.$suffix.csv

# manual cleaning for bug
rm -f *.csv.tmp
for f in pbs-report.raw.$suffix.csv pbs-report.raw.partial.$suffix.csv ; do
 cp -p "$f" "$f".tmp
 sed -i -e 's%^9238329|.*%9238329|jyauyong|medium|GridSearch_set_9.pbs|2019/11/14 10:34|None|std0663/0*24|1|72400kb|1602992kb|4|12|275|0|1%' \
       -e 's%^9238331|.*%9238331|jyauyong|medium|GridSearch_set_10.pbs|2019/11/14 10:34|None|std0504/0*24|1|82704kb|1596968kb|4|12|0|0|1%' \
       -e 's%^9238334|.*%9238334|jyauyong|medium|GridSearch_set_11.pbs|2019/11/14 10:36|None|std0264/0*24|1|69576kb|1546468kb|4|12|0|0|1%' \
       -e 's%^9191524|.*%9191524|tsltaywb|medium|OF-comp_corner|2019/10/31 16:49|None|std0330/0*24|1|2975560kb|16718116kb|137|14|481|0|0%' \
       -e 's%^9605727|.*%9605727|chenq|q4|9NP-SBN4-15c-2|2020/02/04 15:38|None|std0517/0*24+std0525/0*24+std0553/0*24+std0561/0*24+std0569/0*24+std0703/0*24+std0713/0*24+std0717/0*24+std0745/0*24+std0759/0*24+std0772/0*24+std0851/0*24+std1017/0*24+std1018/0*24+std1019/0*24+std1020/0*24+std1021/0*24+std1022/0*24+std1023/0*24+std1024/0*24+std1025/0*24+std1026/0*24+std1027/0*24+std1115/0*24|24|6305420kb|6821284kb|44703987|86447|417856|0|271%' \
    "$f"
 diff "$f" "$f".tmp && rm -f "$f".tmp
done

if [ ${GET_LATEST:-1} -eq 1 ] ; then
 echo get latest application and project data
 if [ -x /app/nsccadmin/log/printjob/get-latest ] ; then /app/nsccadmin/log/printjob/get-latest ; fi
fi

echo second pass of statistics with latest application and qstat information
make veryclean stats

echo get alternate application names
if [ -d load2apps ] ; then (cd load2apps && ./run) ; fi
if [ -d dgx ] ; then make -C dgx veryclean ; fi

echo third pass of statistics with fixed application data
make

if [ ${UPDATE_MYUSAGE:-1} -eq 1 ] ; then
 echo collect AM transaction data
 make -C am > run-cron-am.stdout 2>&1 < /dev/null &
fi

if [ ${UPDATE_MYUSAGE:-1} -eq 1 ] ; then
 echo Update myusage data
 ./update-myusage --all
 ./make-publish
 if [ x"$type" == xmonthly ] ; then
  ./make-copyout
 fi
fi

echo fix file ownership
./fix-permissions

echo make spreadsheet and graphics
ssh ntu01 su $statsuser -c $PWD/make-reporting
if [ ! -f "application_usage-${suffix}.xlsx" ] ; then
 echo attempt 1 failed, retry
 ssh nscc04 su $statsuser -c $PWD/make-reporting
fi

if [ ${MAKE_AGGREGATE:-0} -eq 1 ] ; then
 echo copy raw data to be used in aggregate report
 ./copy-to-aggregate || true
fi

if [ ${UPDATE_MYUSAGE:-1} -eq 1 ] ; then
 ./make-publish
 if [ x"$type" == xweekly ] ; then
  echo circulate weekly spreadsheet via email
  su $statsuser -c $PWD/make-email-draft
  su $statsuser -c $PWD/make-email
  su $statsuser -c $PWD/make-email-trend
 elif [ x"$type" == xmonthly ] ; then
  echo email draft monthly report
  su $statsuser -c $PWD/make-email-monthly-draft
 fi
fi

echo system utilisation data
head cores-mean.$suffix.csv gpus-mean.$suffix.csv
echo
echo alternate application names
sed -e 's/^.*,//' load2apps/alternate.csv  | sort | uniq -c | sort -n

echo check walltime of jobs
./walltime-check
./fix-permissions
echo ===
sort -nk 5 walltime-check.$suffix.stdout | tail -n 10
echo

# wait for AM transaction dump to finish
wait
# publish merged AM data
if [ ${UPDATE_MYUSAGE:-1} -eq 1 ] ; then ./make-publish ; fi
# full reset of file permissions
./fix-permissions --full


if [ ${MAKE_AGGREGATE:-0} -eq 1 ] ; then
 echo update aggregate statistics when running monthly report
 cd /app/nsccadmin/apps/usage-statistics/reports/aggregate && \
   ./aggregate && \
   make && \
   if [ -d load2apps ] ; then (cd load2apps && ./run) ; fi && \
   make && \
   ./update-myusage --all --reset && \
   ./make-publish && \
   ./make-copyout && \
   ./fix-permissions
fi
