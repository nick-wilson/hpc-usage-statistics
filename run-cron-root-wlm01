#!/bin/bash

# This script has settings required to run statistics in cron as root on wlm01
# crontab setting:
# 00 08 29 * * d=/app/nsccadmin/apps/usage-statistics/reports/weekly/20170802-20170808 ; s=run-cron-root-wlm01 ; $d/$s > $d/$s.stdout 2>&1
#
# TODO: replace manual second pass with: run pbsreport, update qstat and job information, generate statistics


cd `dirname $0`
. ./config
monthlydir=`echo $PWD/../../${ey}${em}*`

export PATH="/app/pbs/bin:$PATH:/opt/pbs/bin:/opt/pbs/sbin"
. /etc/profile.d/modules.sh
. /app/modules/modules.sh
module load R
which Rscript

echo first make, only interested in pbs-report data
make veryveryclean pbs-report.raw.$suffix.csv unused.$suffix.csv
make veryclean

if [ ${GET_LATEST:-1} -eq 1 ] ; then
 echo get latest application and project data
 if [ -x /app/nsccadmin/log/printjob/get-latest ] ; then /app/nsccadmin/log/printjob/get-latest ; fi
fi

echo copy in job dependency data
cp -p /app/nsccadmin/log/printjob/depend.csv .

echo second pass of statistics
make veryclean stats

if [ ${UPDATE_MYUSAGE:-1} -eq 1 ] ; then
 echo Update myusage data
 ./update-myusage
fi

echo fix file ownership
./fix-permissions

if [ ${MAKE_AGGREGATE:-0} -eq 1 ] ; then
 echo update aggregate statistics when running monthly report
 cd /app/nsccadmin/apps/usage-statistics/reports/aggregate && \
   ./aggregate && \
   make && \
   ./fix-permissions
fi
