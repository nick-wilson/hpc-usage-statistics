#!/bin/bash

# This script has settings required to run statistics in cron as root on wlm01
# crontab setting:
# 00 08 29 * * d=/app/nsccadmin/apps/usage-statistics/reports/weekly/20170802-20170808 ; s=run-cron-root-wlm01 ; $d/$s > $d/$s.stdout 2>&1
#
# TODO: replace manual second pass with: run pbsreport, update qstat and job information, generate statistics


cd `dirname $0`
. ./config
monthlydir=`echo /app/nsccadmin/apps/usage-statistics/reports/${ey}${em}*`

export PATH="/app/pbs/bin:$PATH:/opt/pbs/bin:/opt/pbs/sbin"
. /etc/profile.d/modules.sh
. /app/modules/modules.sh
module load R
which Rscript

echo first make, only interested in pbs-report data
make veryclean
rm -f *pbs-report.raw.$suffix.csv
make pbs-report.raw.$suffix.csv
./make-unused
make veryclean

if [ $monthly -eq 0 ] ; then
 if [ -d "$monthlydir" ] ; then
  echo same for partial monthly report
  (cd "$monthlydir" && . ./config && rm -f *pbs-report.raw.$suffix.csv && make pbs-report.raw.$suffix.csv && ./make-unused && make veryclean)
 fi
fi

echo get latest application and project data
if [ -x ./tmp.get-qstat ] ; then ./tmp.get-qstat ; fi
echo redo alljobs
if [ -x ./tmp.redo-alljobs ] ; then su $statsuser -c ./tmp.redo-alljobs ; fi

echo second pass of statistics
make veryclean stats

echo Update myusage data
./update-myusage

echo Copy out output files
./make-publish
./fix-permissions
make clean

if [ $monthly -eq 0 ] ; then
 if [ -d "$monthlydir" ] ; then
  echo partial monthly report
  cd "$monthlydir" && \
   . ./config && \
   make veryclean stats && \
  ./make-publish || exit $?
  rm -f $logdir/partial/* && \
  mv -v $logdir/*.$suffix.csv $logdir/weekly/*.$suffix.csv $logdir/partial/
  ./fix-permissions
  make clean
 fi
fi
